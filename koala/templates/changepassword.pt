<metal:block use-macro="main_template">

<div metal:fill-slot="head_css">
    <link rel="stylesheet" href="${request.static_url('koala:static/css/pages/login.css')}" />
    <link rel="stylesheet" href="${request.static_url('koala:static/css/pages/changepassword.css')}" />
</div>

<div metal:fill-slot="head_js">
    <script src="${request.static_url('koala:static/js/thirdparty/utils/zxcvbn-async.js')}"></script>

    <script type="text/javascript">
      function page_loaded() {
        // add password strength meter to first new password field
        $('#new_password').after("<hr id='password-strength'/>");
        $('#new_password').on('keypress', function() {
          var val = $(this).val();
          var score = zxcvbn(val).score;
          $('#password-strength').attr('class', "password_"+score);
        });


        var form = $('#euca-changepassword-form');
        form.on('submit', function() {
          $('.error').css('display', 'none');
          var pass = $(this).find('#password').val();
          var newpass = $(this).find('#new_password').val();
          var newpass2 = $(this).find('#new_password2').val();
          console.log("form fields ="+pass+", "+newpass+", "+newpass2);
          if (pass == newpass) {
            $('#password-different').css('display', 'block');
            return false;
          }
          if (newpass != newpass2) {
            $('#passwords-match').css('display', 'block');
            return false;
          }
        });
      }
    </script>
</div>

<div metal:fill-slot="main_content">

    <div class="row" id="contentwrap">
        <h3 class="header" id="pagetitle" i18n:translate="">
            Change password
        </h3>
        <div class="large-10 columns large-centered">
            <div class="panel has-title" id="changepassword-panel">
                <h6 class="title">Change your password</h6>
                <div tal:condition="password_expired">
                    <p i18n:translate="">Your password has expired. Please update your password.</p>
                </div>
                <div class="row">
                    <div tal:condition="changepassword_form_errors">
                    <div data-alert="alert" class="alert-box alert large-10 large-centered columns"
                            tal:repeat="changepassword_error changepassword_form_errors">
                        ${ changepassword_error }
                        <a href="#" class="close">&times;</a>
                    </div>
                    </div>
                    <div class="large-8 small-12 columns">
                        <form class="custom" id="euca-changepassword-form" method="post" action="${request.route_url('changepassword')}">
                            ${structure:changepassword_form['csrf_token']}
                            <input type="hidden" name="came_from" value="${came_from}" />
                            <input type="hidden" name="account" value="${account}" />
                            <input type="hidden" name="username" value="${username}" />
                            ${panel('form_field', field=changepassword_form.password, required='required')}
                            ${panel('form_field', field=changepassword_form.new_password, required='required')}
                            <div class="row">
                              <div class="small-4 columns"></div>
                              <div class="small-8 columns">
                                <small id="password-different" class="error" style="display:none;" i18n:translate="">New password must be different than old one</small>
                              </div>
                            </div>
                            ${panel('form_field', field=changepassword_form.new_password2, required='required')}
                            <div class="row">
                              <div class="small-4 columns"></div>
                              <div class="small-8 columns">
                                <small id="passwords-match" class="error" style="display:none;" i18n:translate="">Passwords must match</small>
                              </div>
                            </div>
                            <div class="row">
                                <div class="small-4 columns"></div>
                                <div class="small-8 columns">
                                    <button type="submit" class="button radius" i18n:translate="">Change password</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</metal:block>
