<metal:block use-macro="main_template">

<head metal:fill-slot="head_css">
    <link rel="stylesheet" type="text/css" href="${request.static_url('koala:static/css/thirdparty/chosen.min.css')}" />
    <link rel="stylesheet" type="text/css" href="${request.static_url('koala:static/css/pages/instance_launch.css')}" />
</head>

<div metal:fill-slot="main_content">
    <div class="row" id="contentwrap" ng-app="LaunchInstance" ng-controller="LaunchInstanceCtrl"
         ng-init="initController('${securitygroups_rules_json}', '${keypair_choices_json}', '${securitygroup_choices_json}')">
        <h3 class="header" id="pagetitle">
            <metal:breadcrumbs metal:use-macro="layout.global_macros['breadcrumbs']">
                <metal:crumbs metal:fill-slot="crumbs">
                    <li><a href="${request.route_url('instances')}" i18n:translate="">Instances</a></li>
                    <li class="current"><a href="#" i18n:translate="">Launch instance</a></li>
                </metal:crumbs>
            </metal:breadcrumbs>
        </h3>
        <!-- Notifications -->
        <metal:block metal:use-macro="layout.global_macros['notifications']" />
        <div class="large-8 columns" tal:define="_ import: pyramid.i18n.TranslationString">
            <div class="wizard no-title">
                <form action="${request.route_url('instance_launch')}" id="launch-instance-form"
                      method="post" data-abide="abide" enctype="multipart/form-data">
                    ${structure:launch_form['csrf_token']}
                    ${structure:launch_form['image_id']}
                    <dl class="tabs" data-tab="">
                        <dd class="${'active' if not image else ''}">
                            <a id="tabStep1" href="#step1">
                                <span class="cir">1</span> <b>Image</b>
                            </a>
                        </dd>
                        <dd class="${'active' if image else 'disabled'}">
                            <a id="tabStep2" tal:attributes="href '#step2' if image else None" tal:omit-tag="not image">
                                <span class="cir">2</span> <b>Details</b>
                            </a>
                        </dd>
                        <dd class="${'' if image else 'disabled'}">
                            <a id="tabStep3"  tal:attributes="href '#step3' if image else None" tal:omit-tag="not image">
                                <span class="cir">3</span> <b>Security</b>
                            </a>
                        </dd>
                        <dd class="${'' if image else 'disabled'}">
                            <a id="tabStep4" tal:attributes="href '#step4' if image else None" tal:omit-tag="not image">
                                <span class="cir">4</span> <b>Advanced</b>
                            </a>
                        </dd>
                    </dl>
                    <div class="tabs-content">
                        <!--! Step 1: Image tab content -->
                        <div class="content ${'active' if not image else ''}" id="step1">
                            <p class="description" i18n:translate="">
                                Specify a machine image for your virtual machine instance
                            </p>
                            <div class="row">
                                <div class="small-4 columns">
                                    <label i18n:translate="" class="right inline-label">Enter an Image ID</label>
                                </div>
                                <div class="small-8 columns value">
                                    <input type="text" name="image_id" id="image-id-input" ng-model="imageID" />
                                    <a class="button secondary small" i18n:translate="" id="image-id-btn"
                                       ng-click="inputImageID('${request.route_url('instance_create')}')">Next</a>
                                </div>
                            </div>
                            <p>OR select an image below</p>
                            ${panel('image_picker', image=image, owner_choices=owner_choices,
                                    images_json_endpoint=images_json_endpoint)}
                            <div class="row" tal:condition="image">
                                <div class="small-4 columns">&nbsp;</div>
                                <div class="small-8 columns field inline">
                                    <a id="visit-step-2" class="button small round" ng-click="visitNextStep(2, $event)">
                                        <span i18n:translate="">Next</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <!--! Step 2: Type tab content -->
                        <div class="content ${'active' if image else ''}" id="step2">
                            <p class="description" i18n:translate="">
                                Specify the number, name(s), size, availability zone, and tags.
                            </p>
                            ${panel('form_field', field=launch_form['number'], leftcol_width=3, rightcol_width=9,
                                    min=1, maxlength=2, ng_attrs={'model': 'instanceNumber'})}
                            <div class="row controls-wrapper" ng-cloak="">
                                <div class="small-3 columns">
                                    <label>
                                        <span i18n:translate="">Name</span><span ng-show="instanceNumber > 1">s</span>
                                    </label>
                                </div>
                                <div class="small-9 columns field inline">
                                    <span ng-repeat="name in buildNumberList(instanceNumber)">
                                        <input class="name" placeholder="instance{{ $index + 1 }}"
                                               name="name_{{ $index }}" ng-model="instanceNames[$index]" />
                                    </span>
                                </div>
                            </div>
                            ${panel('form_field', field=launch_form['instance_type'], leftcol_width=3, rightcol_width=9,
                                    ng_attrs={'model': 'instanceType'})}
                            ${panel('form_field', field=launch_form['zone'], leftcol_width=3, rightcol_width=9,
                                    ng_attrs={'model': 'instanceZone'})}
                            ${panel('tag_editor', leftcol_width=3, rightcol_width=9)}
                            <hr />
                            <div class="row">
                                <div class="small-3 columns">&nbsp;</div>
                                <div class="small-9 columns field inline">
                                    <a id="visit-step-3" class="button small round" ng-click="visitNextStep(3, $event)">
                                        <span i18n:translate="">Next</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <!--! Step 3: Security tab content -->
                        <div class="content" id="step3">
                            <p class="description" i18n:translate="">Specify key pair and security group.</p>
                            ${panel('form_field', field=launch_form['keypair'], leftcol_width=3, rightcol_width=9,
                                    ng_attrs={'model': 'keyPair', 'options': 'k as v for (k, v) in keyPairChoices'})}
                            <div class="row">
                                <div class="small-9 columns right">
                                    <a data-reveal-id="create-keypair-modal" i18n:translate=""
                                       id="create-keypair-link">Create key pair</a>
                                </div>
                            </div>
                            ${panel('form_field', field=launch_form['securitygroup'], leftcol_width=3, rightcol_width=9,
                                ng_attrs={'model': 'securityGroup', 'change': 'updateSelectedSecurityGroupRules()',
                                          'options': 'k as v for (k, v) in securityGroupChoices'})}
                            <div class="row">
                                <div class="small-9 columns right">
                                    <a data-reveal-id="create-securitygroup-modal" i18n:translate=""
                                       id="create-securitygroup-link">Create security group</a>
                                </div>
                            </div>
                            ${panel('securitygroup_rules_preview')}
                            <hr />
                            <div class="row">
                                <div class="small-3 columns">&nbsp;</div>
                                <div class="small-9 columns field inline">
                                    <button type="submit" class="button" id="launch-instance-btn-step3">
                                        <span i18n:translate="">Launch instance<span ng-show="instanceNumber > 1">s</span></span>
                                    </button><br />
                                    <span class="or">Or:</span>
                                    <a id="visit-step-4" ng-click="visitNextStep(4, $event)">
                                        <span i18n:translate="">Select advanced options</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <!--! Step 4: Advanced tab content -->
                        <div class="content" id="step4">
                            <p class="description" i18n:translate="">
                                User data and other advanced options (optional).
                            </p>
                            ${panel('form_field', field=launch_form['userdata'], ng_attrs={'model': 'userData'})}
                            ${panel('form_field', field=launch_form['userdata_file'], ng_attrs={'model': 'userDataFile'})}
                            ${panel('form_field', field=launch_form['kernel_id'])}
                            ${panel('form_field', field=launch_form['ramdisk_id'])}
                            ${panel('form_field', field=launch_form['monitoring_enabled'], ng_attrs={'model': 'monitoringEnabled'})}
                            ${panel('form_field', field=launch_form['private_addressing'], ng_attrs={'model': 'privateAddressing'})}
                            ${panel('bdmapping_editor', image=image, snapshot_choices=snapshot_choices)}
                            <div class="row" tal:condition="image">
                                <div class="small-4 columns">&nbsp;</div>
                                <div class="small-8 columns field inline">
                                    <button type="submit" class="button" id="launch-instance-btn-step4">
                                        <span i18n:translate="">Launch instance<span ng-show="instanceNumber > 1">s</span></span>
                                    </button>
                                    <a href="${request.route_url('instances')}"
                                       class="cancel-link" i18n:translate="">Cancel</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="clearfix">&nbsp;</div>
                </form>
            </div>
        </div>
        <div class="large-4 columns summary" ng-cloak="" tal:condition="image">
            <h5 i18n:translate="" class="title">Summary</h5>
            <div class="section">
                <div class="row">
                    <label i18n:translate="">Image:</label>
                    <div class="columns value">${image.name or image.id}</div>
                </div>
                <div class="row">
                    <label i18n:translate="">Platform:</label>
                    <div class="columns value">${image.platform_name}</div>
                </div>
                <div class="row">
                    <label i18n:translate="">Root device:</label>
                    <div class="columns value">${image.root_device_type}</div>
                </div>
            </div>
            <div class="section">
                <div class="row">
                    <label i18n:translate="">Size:</label>
                    <div class="columns value">{{ instanceType }}</div>
                </div>
                <div class="row">
                    <label i18n:translate="">Number:</label>
                    <div class="columns value">{{ instanceNumber }}</div>
                </div>
                <div class="row">
                    <label i18n:translate="">Zone:</label>
                    <div class="columns value">{{ instanceZone }}</div>
                </div>
                <div class="row">
                    <label i18n:translate="">Names:</label>
                    <div class="columns value">
                        <span ng-repeat="instanceName in instanceNames">
                            {{ instanceName }}<span ng-show="!$last">, </span>
                        </span>
                    </div>
                </div>
                <div class="row">
                    <label i18n:translate="">Tags:</label>
                    <div class="columns value" id="tag-preview">
                        <div ng-repeat="(name, value) in tagsObject">{{ name }}={{ value }}</div>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="row">
                    <label i18n:translate="">Key:</label>
                    <div class="columns value">{{ keyPair }}</div>
                </div>
                <div class="row">
                    <label i18n:translate="">Security group:</label>
                    <div class="columns value">{{ securityGroup }}</div>
                </div>
            </div>
            <div class="section">
                <div class="row">
                    <div class="columns value" ng-show="userData || userDataFile">
                        <i class="fi-check"></i> User data added
                    </div>
                </div>
                <div class="row">
                    <div class="columns value" ng-show="monitoringEnabled">
                        <i class="fi-check"></i> Monitoring enabled
                    </div>
                </div>
                <div class="row">
                    <div class="columns value" ng-show="privateAddressing">
                        <i class="fi-check"></i> Uses private addressing
                    </div>
                </div>
            </div>
        </div>
        <!--! Modal dialogs -->
        <div id="create-keypair-modal" class="reveal-modal medium" data-reveal="" ng-cloak="">
            <h3 i18n:translate="">Create key pair</h3>
            <p i18n:translate="">You can use this key pair to connect to the instances you launch here.</p>
            <p i18n:translate="">
                Save the key pair the file in a place you will remember.
                You will need to enter the path later to connect to your instances.
            </p>
            <form method="post" data-abide="abide" ng-show="!showKeyPairMaterial" id="create-keypair-form"
                  ng-submit="handleKeyPairCreate($event, '${request.route_url('keypair_create')}')">
                ${structure:keypair_form['csrf_token']}
                ${panel('form_field', field=keypair_form['name'], ng_attrs={'model': 'newKeyPairName'},
                        leftcol_width=3, rightcol_width=9)}
                <hr>
                <div class="row">
                    <div class="small-3 columns">&nbsp;</div>
                    <div class="small-9 columns field inline">
                        <button type="submit" class="button" id="create-keypair-btn"
                                i18n:translate="" ng-disabled="isLoadingKeyPair">
                            Create key pair
                        </button>
                    </div>
                </div>
            </form>
            <form ng-show="showKeyPairMaterial" ng-submit="downloadKeyPair($event, '${request.route_url('generate_file')}')">
                ${structure:generate_file_form['csrf_token']}
                <textarea id="keypair-material" name="content"></textarea>
                <button type="submit" class="button" id="confirm-keypair-btn" i18n:translate="">
                    Download key pair file
                </button>
            </form>
            <a class="close-reveal-modal">&#215;</a>
        </div>
        <div id="create-securitygroup-modal" class="reveal-modal medium" data-reveal="" ng-cloak="">
            <h3 i18n:translate="">Create security group</h3>
            <p i18n:translate=""></p>
            <form method="post" data-abide="abide" id="create-securitygroup-form"
                  ng-submit="handleSecurityGroupCreate($event, '${request.route_url('securitygroup_create')}')">
                ${structure:securitygroup_form['csrf_token']}
                ${panel('form_field', field=securitygroup_form['name'], ng_attrs={'model': 'newSecurityGroupName'},
                        leftcol_width=3, rightcol_width=9)}
                ${panel('form_field', field=securitygroup_form['description'], ng_attrs={'model': 'newSecurityGroupDesc'},
                        leftcol_width=3, rightcol_width=9)}
                <hr />
                ${panel('securitygroup_rules', groupnames=security_group_names)}
                <hr />
                <div class="row">
                    <div class="small-3 columns">&nbsp;</div>
                    <div class="small-9 columns field inline">
                        <button type="submit" class="button" id="create-securitygroup-btn"
                                i18n:translate="" ng-disabled="isLoadingSecurityGroup">
                            Create security group
                        </button>
                    </div>
                </div>
            </form>
            <a class="close-reveal-modal">&#215;</a>
        </div>
    </div>
</div>

<div metal:fill-slot="tail_js">
    <script src="${request.static_url('koala:static/js/thirdparty/jquery/chosen.jquery.min.js')}"></script>
    <script src="${request.static_url('koala:static/js/thirdparty/utils/purl.js')}"></script>
    <script src="${request.static_url('koala:static/js/thirdparty/jquery/jquery.generateFile.js')}"></script>
    <script src="${request.static_url('koala:static/js/pages/instance_launch.js')}"></script>
</div>

</metal:block>

